name: Generate Changelog

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    # Only run if PR is from beta branch
    if: github.event.pull_request.head.ref == 'beta' && github.event.pull_request.base.ref == 'main'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Generate changelog entries
        env:
          GH_TOKEN: ${{ github.token }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          # Create a new branch from the current HEAD (which is the PR head SHA)
          BRANCH_NAME="changelog/pr-${{ github.event.pull_request.number }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          # Get the date range for the changelog
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          FIRST_COMMIT_DATE=$(git log --format=%ai -1 "$BASE_SHA" | cut -d' ' -f1)
          LAST_COMMIT_DATE=$(git log --format=%ai -1 "$HEAD_SHA" | cut -d' ' -f1)

          # Generate changelog using Cursor CLI
          agent -p --force \
            "Analyze the changes in this pull request from beta to main. 
            
            Create changelog entries following the Deltalytix format:
            
            **File Structure:**
            - Create files in both \`content/updates/en\` and \`content/updates/fr\`
            - Filename: kebab-case-title.mdx (descriptive, lowercase with hyphens)
            
            **Frontmatter:**
            ---
            title: 'Human-readable title'
            description: 'Short description'
            date: '$FIRST_COMMIT_DATE'
            status: completed
            completedDate: '$LAST_COMMIT_DATE'
            ---
            
            **Content Guidelines:**
            - 2-4 short paragraphs; add headings or bullets only if it helps
            - Examine recent changelogs in content/updates/en/ to understand format
            - Simple language: Avoid jargon, be conversational
            - Human tone: Informal, not corporate-sounding
            - Avoid the word 'programmatically'
            - Focus on user-facing product changes; skip infra-only changes
            - Start with what was added/changed
            - Explain the benefit or use case
            - Call out specific UX/UI surfaces and behaviors
            
            Generate changelog entries for all significant user-facing changes in this PR. 
            Create separate entries for distinct features/changes. 
            Write in both English and French (create files in both directories).
            
            Only create changelog files - do not modify any other files." --model auto

          # Check if changelog files were created
          if [ -z "$(git status --porcelain content/updates/)" ]; then
            echo "No changelog entries generated. Exiting."
            exit 0
          fi

          # Commit changelog entries
          git add content/updates/
          git commit -m "docs: add changelog entries for PR #${{ github.event.pull_request.number }}"
          git push origin "$BRANCH_NAME"

          # Create pull request
          gh pr create \
            --title "üìù Changelog entries for PR #${{ github.event.pull_request.number }}" \
            --body "This PR contains changelog entries generated for [PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}).
            
            ## Generated by
            - Workflow: ${{ github.workflow }}
            - Run: ${{ github.run_id }}
            - Base: ${{ github.event.pull_request.base.ref }}
            - Head: ${{ github.event.pull_request.head.ref }}
            
            ## Next Steps
            Review the changelog entries and merge this PR along with the main PR." \
            --base "${{ github.event.pull_request.head.ref }}" \
            --head "$BRANCH_NAME"
